{# templates/configuration.html #}
{% extends "base.html" %}

{% block title %}System Configuration{% endblock %}

{% block head %}
<style>
        .config-container {
        display: flex;
        align-items: flex-start;
        gap: 20px;
    }
    .config-section, .config-controls {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .config-section {
        flex: 2;
    }
    .config-controls {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
	max-width: 400;
    }
    .config-title {
        margin-top: 0;
        color: #2c3e50;
        font-size: 1.5em;
    }
    .json-display {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 600px;
        overflow-y: auto;
    }
    .upload-button, .test-button {
        background-color: #007bff;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .upload-button:hover, .test-button:hover {
        background-color: #0056b3;
    }
        .firmware-control-container {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .form-actions {
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-warning {
        background-color: #ffc107;
        color: #212529;
    }
</style>
{% endblock %}

{% block content %}
<h1>Firmware version and control</h1>

<div class="firmware-control-container">
    Current version: {{ current_branch }}
    <form action="/configuration/update_firmware" method="post">
        <div class="form-group">
            <span><span>
            <label for="git-branch">Select firmware version:</label>
            <select id="git-branch" name="branch" class="form-control">
                {% for branch in git_branches %}
                    <option value="{{ branch }}" {% if branch == current_branch %}selected{% endif %}>{{ branch }}</option>
                {% endfor %}
            </select>
                </span>

            <div class="form-actions">
                <button type="submit" name="action" value="update" class="btn btn-primary">Update</button>
                <button type="submit" name="action" value="update_restart" class="btn btn-warning">Update & Restart</button>
            </div>
                </span>
       </div>
    </form>
</div>

<h1>System commission and configuration</h1>
<div class="firmware-control-container">
      <button class="test-button" onclick="recommission()">Recommission system</button>
      <button class="test-button" onclick="reconfigure()">Reconfigure system</button>
</div>

<h1>Services Status</h1>
<div class="config-container">
{% for service in ["vmc-ui", "cmd-controller", "iot-controller"] %}
    <span>
        {{ service }}
        <button class="test-button" onclick="serviceAction('{{ service }}', 'status')">Status</button>
        <button class="test-button" onclick="serviceAction('{{ service }}', 'restart')">Restart</button>
        <button class="test-button" onclick="serviceAction('{{ service }}', 'stop')">Stop</button>
    </span>
{% endfor %}
    <textarea id="{{ service }}Response" class="json-display" readonly></textarea>
</div>

<h1>System Configuration</h1>
{% for config in ["Actuators", "BMS", "Inverter", "Generation"] %}
<div class="config-container">
    <div class="config-section">
        <h3 class="config-title">{{ config }} Configuration</h3>
        <form class="upload-form" id="{{ config | lower }}ConfigForm">
            <input type="file" accept=".json" id="{{ config }}ConfigFile" style="display: none;">
            <button type="button" class="upload-button" onclick="document.getElementById('{{ config }}ConfigFile').click()">
                Load {{ config }} configuration
            </button>
        </form>
        <div id="{{ config | lower }}ConfigDisplay" class="json-display" contenteditable="true">
            {% set definition = hardware.get_hardware_definition(config) %}
            {{ definition | tojson(indent=4) if definition else "No configuration loaded" }}
        </div>
    </div>
    <div class="config-controls">
        <h1>{{ config }} Test and Diagnostics</h1>
        <span>
            <button class="test-button" onclick="testConfig('{{ config }}')">Test system</button>
            <button class="test-button" onclick="resetConfig('{{ config }}')">Reset system</button>
            <button class="test-button" onclick="diagnosticsConfig('{{ config }}')">Diagnostics</button>
            <button class="test-button" onclick="alarmsConfig('{{ config }}')">Query Alarms</button>
        </span>
        <textarea id="{{ config }}Response" class="json-display" readonly></textarea>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
    async function recommission() {
        try {
            const response = await fetch(`/configuration/recommission`, { method: 'POST' });
            const data = await response.json();
        } catch (error) {
            console.log("BAD ERROR");
        }
    }

    async function reconfigure() {
        try {
            const response = await fetch(`/configuration/reconfigure`, { method: 'POST' });
            const data = await response.json();
        } catch (error) {
            console.log("BAD ERROR");
        }
    }

    async function serviceAction(service, action) {
        const responseBox = document.getElementById(`${service}Response`);
        responseBox.value = `Executing ${action} on ${service}...`;

        try {
            const response = await fetch(`/configuration/service/${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ service: service })
            });

            const data = await response.json();
            responseBox.value = JSON.stringify(data, null, 2);
        } catch (error) {
            responseBox.value = `Error executing ${action} on ${service}: ${error.message}`;
        }
    }

    async function testConfig(section) {
        const responseBox = document.getElementById(`${section}Response`);
        try {
            const response = await fetch(`/configuration/ping/${section}`, { method: 'POST' });
            const data = await response.json();
            responseBox.value = data.output || data.error;
        } catch (error) {
            responseBox.value = "Error executing hardware test.";
        }
    }

    async function diagnosticsConfig(section) {
        const responseBox = document.getElementById(`${section}Response`);
        try {
            const response = await fetch(`/configuration/diagnose/${section}`, { method: 'POST' });
            const data = await response.json();
            responseBox.value = data.output || data.error;
        } catch (error) {
            responseBox.value = "Error executing hardware diagnosis.";
        }
    }


    async function alarmsConfig(section) {
        const responseBox = document.getElementById(`${section}Response`);
        try {
            const response = await fetch(`/configuration/test_alarms/${section}`, { method: 'POST' });
            const data = await response.json();
            responseBox.value = data.output || data.error;
        } catch (error) {
            responseBox.value = "Error executing hardware diagnosis.";
        }
    }


    async function resetConfig(section) {
        const responseBox = document.getElementById(`${section}Response`);
        try {
            const response = await fetch(`/configuration/test_alarms/${section}`, { method: 'POST' });
            const data = await response.json();
            responseBox.value = data.output || data.error;
        } catch (error) {
            responseBox.value = "Error executing hardware diagnosis.";
        }
    }


    
    const configSections = ["Actuators", "BMS", "Inverter", "Generation"];
    configSections.forEach(section => {
        const fileInput = document.getElementById(`${section}ConfigFile`);
        const display = document.getElementById(`${section}ConfigDisplay`);

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch(`/configuration/upload/${section}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        display.textContent = JSON.stringify(result.config, null, 2);
                    } else {
                        display.textContent = 'Error uploading configuration';
                    }
                } catch (error) {
                    display.textContent = 'Error processing configuration file';
                }
            }
        });
    });
</script>
{% endblock %}
