{% extends "base.html" %}

{% block title %}Generation{% endblock %}
{% block head %}
{% endblock %}

{% block content %}
    <h1>Photovoltaic Generation System (CT devices)</h1>
    <div id="error-message" class="error" style="display: none;"></div>

    <div class="metadata">
        <div>
            Number of Units: <span id="unit-count">-</span>
        </div>
        <div class="status-indicator">
            Last refresh: <span id="last-refresh">-</span>
        </div>
    </div>
    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
        <div>
            <label for="lookback">Number of chart data points:</label>
            <input type="number" id="lookback" min="10" value="800" step="100">
        </div>
        <button onclick="updateData()">Refresh</button>
    </div>

    {% for ct in hardware.devices %}
    {% set unit_id = ct['mac'] %}
    <div class="side-by-side-container">
        <!-- Left side: Unit Specification -->
        <div class="side-by-side-item">
            <div class="unit-container">
                <div class="unit-specification">
                    <h2>Unit Specification</h2>
                    <div class="specification-table">
                        <div class="specification-row">
                            <div class="specification-label">CREM3 MAC:</div>
                            <div class="specification-value {% if hardware.mac != hardware.identifier %}error-text{% endif %}">
                                {{ct.mac}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <h3>Status Table</h3>
    <table>
        <thead>
        <tr>
            <th>Name</th>
            <th>Value</th>
            <th>Description</th>
        </tr>
        </thead>
        <tbody>
        {% for reg in register_map %}
        <tr>
            <td>{{ reg.name }}</td>
            <td class="value-cell" id="value-{{ unit_id }}-{{ reg.name }}">
                -
            </td>
            <td>{{ reg.description }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    <div class="chart-container">
        <h3>Historical Data</h3>
        <div id="charts-unit{{ unit_id }}">
            <div class="text-gray-500">Loading charts...</div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
function fetchAndDisplayTestData(divId = 'results') {
  // Get the div element where results will be displayed
  const resultsDiv = document.getElementById(divId);

  // Show loading state
  if (resultsDiv) {
    resultsDiv.innerHTML = 'Loading...';
  }

  // Fetch data from the API
  fetch('/generation/data')
    .then(response => {
      // Check if the request was successful
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      // Parse the JSON response
      return response.json();
    })
    .then(data => {
      // Display the result in the div
      if (resultsDiv) {
        // Format the JSON for better readability
        resultsDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      }
    })
    .catch(error => {
      // Handle any errors
      if (resultsDiv) {
        resultsDiv.innerHTML = `Error: ${error.message}`;
      }
      console.error('Fetch error:', error);
    });
}

// Example usage:
// Call the function when the page loads
document.addEventListener('DOMContentLoaded', () => {
  fetchAndDisplayTestData();
});

// Or call it with a custom div ID
// fetchAndDisplayTestData('customResultsDiv');
</script>
{% endblock %}