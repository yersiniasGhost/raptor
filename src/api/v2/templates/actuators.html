{# templates/actuators.html #}
{% extends "base.html" %}

{% block title %} BMS {% endblock %}
{% block head %}
    <style>
        .actuator-panel {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .control-form {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .form-group {
            margin: 8px 0;
        }
        label {
            display: inline-block;
            width: 120px;
        }
        input[type="number"] {
            width: 100px;
            padding: 4px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status-moving {
            color: blue;
        }
    </style>
{% endblock %}

{% block content %}
    <h1>Actuator Control System</h1>
    
    <!-- Actuator 1 Panel -->
    <div class="actuator-panel">
        <h2>Actuator 1</h2>
        <table id="actuator1-table">
            <tr>
                <th>Parameter</th>
                <th>Value</th>
                <th>Units</th>
            </tr>
            <tr>
                <td>Position</td>
                <td id="act1-position">Loading...</td>
                <td>mm</td>
            </tr>
            <tr>
                <td>Current</td>
                <td id="act1-current">Loading...</td>
                <td>A</td>
            </tr>
            <tr>
                <td>Speed</td>
                <td id="act1-speed">Loading...</td>
                <td>%</td>
            </tr>
            <tr>
                <td>Voltage</td>
                <td id="act1-voltage">Loading...</td>
                <td>V</td>
            </tr>
        </table>

        <div class="control-form">
            <h3>Control Panel</h3>
            <form id="actuator1-form" onsubmit="moveActuator(1, event)">
                <div class="form-group">
                    <label for="target-position-1">Target Position:</label>
                    <input type="number" id="target-position-1" step="0.1" required>
                    <span>mm</span>
                </div>
                <div class="form-group">
                    <label for="target-speed-1">Target Speed:</label>
                    <input type="number" id="target-speed-1" min="1" max="100" step="1" required>
                    <span>%</span>
                </div>
                 <div class="checkbox-group">
                    <input type="checkbox" id="activate-alarm-1">
                    <label for="activate-alarm-1">Activate Alarm</label>
                </div>
                <button type="submit" id="move-button-1">Move Actuator</button>
            </form>
        </div>
    </div>

    <!-- Actuator 2 Panel -->
    <div class="actuator-panel">
        <h2>Actuator 2</h2>
        <table id="actuator2-table">
            <tr>
                <th>Parameter</th>
                <th>Value</th>
                <th>Units</th>
            </tr>
            <tr>
                <td>Position</td>
                <td id="act2-position">Loading...</td>
                <td>mm</td>
            </tr>
            <tr>
                <td>Current</td>
                <td id="act2-current">Loading...</td>
                <td>A</td>
            </tr>
            <tr>
                <td>Speed</td>
                <td id="act2-speed">Loading...</td>
                <td>%</td>
            </tr>
            <tr>
                <td>Voltage</td>
                <td id="act2-voltage">Loading...</td>
                <td>V</td>
            </tr>
        </table>

        <div class="control-form">
            <h3>Control Panel</h3>
            <form id="actuator2-form" onsubmit="moveActuator(2, event)">
                <div class="form-group">
                    <label for="target-position-2">Target Position:</label>
                    <input type="number" id="target-position-2" step="0.1" required>
                    <span>mm</span>
                </div>
                <div class="form-group">
                    <label for="target-speed-2">Target Speed:</label>
                    <input type="number" id="target-speed-2" min="1" max="100" step="1" required>
                    <span>%</span>
                </div>
                 <div class="checkbox-group">
                    <input type="checkbox" id="activate-alarm-2">
                    <label for="activate-alarm-2">Activate Alarm</label>
                </div>
                <button type="submit" id="move-button-2">Move Actuator</button>
            </form>
        </div>
    </div>
    <!-- Combined Control Panel -->
    <div class="actuator-panel" id="combined-control-panel">
        <h2>Combined Actuator Control</h2>
        <div class="control-form">
            <h3>Move Both Actuators</h3>
            <form id="combined-form" onsubmit="moveBothActuators(event)">
                <div class="form-group">
                    <label for="target-position-both">Target Position:</label>
                    <input type="number" id="target-position-both" step="0.1" required>
                    <span>mm</span>
                </div>
                <div class="form-group">
                    <label for="target-speed-both">Target Speed:</label>
                    <input type="number" id="target-speed-both" step="0.1" required>
                    <span>mm/s</span>
                </div>
                 <div class="checkbox-group">
                    <input type="checkbox" id="activate-alarm-both">
                    <label for="activate-alarm-both">Activate Alarm</label>
                </div>
                <button type="submit" id="move-button-both">Move Both Actuators</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // Track movement state
        const movementState = {
            1: false,
            2: false
        };

        let lastPosition = {
            1: null,
            2: null
        };

        let stableCount = {
            1: 0,
            2: 0
        };

        // Update actuator status with optimized polling
        async function updateActuatorStatus(actuatorId) {
            try {
                const response = await fetch(`/actuator/${actuatorId}/status`);
                const data = await response.json();
                
                // Update display
                document.getElementById(`act${actuatorId}-position`).textContent = data.position.toFixed(1);
                document.getElementById(`act${actuatorId}-current`).textContent = data.current.toFixed(2);
                document.getElementById(`act${actuatorId}-speed`).textContent = data.speed.toFixed(1);
                document.getElementById(`act${actuatorId}-voltage`).textContent = data.voltage.toFixed(1);

                // Check if movement has completed
                if (movementState[actuatorId]) {
                    if (lastPosition[actuatorId] !== null) {
                        if (Math.abs(data.position - lastPosition[actuatorId]) < 0.1) {
                            stableCount[actuatorId]++;
                            if (stableCount[actuatorId] >= 5) {
                                movementState[actuatorId] = false;
                                document.getElementById(`move-button-${actuatorId}`).disabled = false;
                                document.getElementById(`move-button-both`).disabled = false;
                                stableCount[actuatorId] = 0;
                            }
                        } else {
                            stableCount[actuatorId] = 0;
                        }
                    }
                    lastPosition[actuatorId] = data.position;
                }

            } catch (error) {
                console.error(`Error updating actuator ${actuatorId} status:`, error);
            }
        }

        // Move actuator with state tracking
        async function moveActuator(actuatorId, event) {
            event.preventDefault();
            
            const button = document.getElementById(`move-button-${actuatorId}`);
            button.disabled = true;
            movementState[actuatorId] = true;
            lastPosition[actuatorId] = null;
            stableCount[actuatorId] = 0;
            
            const targetPosition = document.getElementById(`target-position-${actuatorId}`).value;
            const targetSpeed = document.getElementById(`target-speed-${actuatorId}`).value;
            const activateAlarm = document.getElementById(`activate-alarm-${actuatorId}`).checked;
            
            const formData = new FormData();
            formData.append('target_position', targetPosition);
            formData.append('target_speed', targetSpeed);
            formData.append('activate_alarm', activateAlarm);

            try {
                const response = await fetch(`/actuator/${actuatorId}/move`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Movement command failed');
                }
            } catch (error) {
                console.error('Error moving actuator:', error);
                alert('Error sending movement command');
                button.disabled = false;
                movementState[actuatorId] = false;
            }
        }

        // Move actuator with state tracking
        async function moveBothActuators(event) {
            event.preventDefault();
            
            const button = document.getElementById('move-button-both');
            button.disabled = true;

            // Set movement state for both actuators
            movementState[1] = true;
            movementState[2] = true;
            lastPosition[1] = null;
            lastPosition[2] = null;
            stableCount[1] = 0;
            stableCount[2] = 0;
            
            const targetPosition = document.getElementById('target-position-both').value;
            const targetSpeed = document.getElementById('target-speed-both').value;
            const activateAlarm = document.getElementById(`activate-alarm-both`).checked;
            
            const formData = new FormData();
            formData.append('target_position', targetPosition);
            formData.append('target_speed', targetSpeed);
            formData.append('activate_alarm', activateAlarm);


            try {
                const response = await fetch('/move-multiple', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Movement command failed');
                }

                const result = await response.json();
                console.log(result.message);
            } catch (error) {
                console.error('Error moving actuators:', error);
                alert('Error sending movement command');
                // Reset states on error
                movementState[1] = false;
                movementState[2] = false;
                button.disabled = false;
            }
        }



        // Initialize status updates with dynamic polling rate
        function startStatusUpdates() {
            const updateInterval = 2000; // 2000ms base interval
            
            setInterval(() => {
                const pollRate = (movementState[1] || movementState[2]) ? 100 : 500;
                if (Math.random() < updateInterval / pollRate) {
                    updateActuatorStatus(1);
                    updateActuatorStatus(2);
                }
            }, updateInterval);
        }

        // Start the status updates
        startStatusUpdates();
    </script>
{% endblock %}
